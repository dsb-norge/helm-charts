name: 'Release the chart'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (SemVer)'
        required: true
      description:
        description: 'Desciption'
        required: true

env:
  CHART_NAME: 'dsb-spring-boot'
  # Needed to deploy helm chart as oci bundle:
  HELM_EXPERIMENTAL_OCI: 1

jobs:
  set-variables:
    name: Release the chart
    runs-on: self-hosted

    steps:
      - name: Checkout working branch
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Update chart version in Chart.yaml
        run: "sed -i 's/^version:.*/version: ${{ github.event.inputs.version }}/' ${{ env.CHART_NAME }}/Chart.yaml"

      - name: Run linting
        run: helm lint dsb-spring-boot

      - name: Login to registry
        run: echo  ${{ secrets.AZ_CR_SECRET }} | helm registry login ${{ secrets.AZ_CR_SERVER }} --username ${{ secrets.AZ_CR_USER }} --password-stdin

      - name: Save helm chart
        run: helm chart save ./dsb-spring-boot ${{ secrets.AZ_CR_SERVER }}/helm/${{ env.CHART_NAME }}:${{ github.event.inputs.version }}

      - name: Push helm chart
        run: helm chart push ${{ secrets.AZ_CR_SERVER }}/helm/${{ env.CHART_NAME }}:${{ github.event.inputs.version }}

      - name: Create GitHub release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
        with:
          tag_name: v${{ github.event.inputs.version }}
          release_name: Release ${{ github.event.inputs.version }}
          body: ${{ github.event.inputs.description }}
